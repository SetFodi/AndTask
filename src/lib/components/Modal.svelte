<script lang="ts">
  import { createEventDispatcher, onMount } from 'svelte';
  import { scale, fly } from 'svelte/transition';
  import { quintOut } from 'svelte/easing';
  
  interface Props {
    open?: boolean;
    size?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
    persistent?: boolean;
    showCloseButton?: boolean;
    title?: string;
    description?: string;
    children?: import('svelte').Snippet;
    footer?: import('svelte').Snippet;
  }
  
  let {
    open = false,
    size = 'md',
    persistent = false,
    showCloseButton = true,
    title,
    description,
    children,
    footer,
    onClose
  }: Props & { onClose?: () => void } = $props();
  
  const dispatch = createEventDispatcher();\n  let modalElement: HTMLDivElement;\n  let previouslyFocused: HTMLElement | null = null;\n  \n  function handleEscape(event: KeyboardEvent) {\n    if (event.key === 'Escape' && !persistent) {\n      handleClose();\n    }\n  }\n  \n  function handleBackdropClick(event: MouseEvent) {\n    if (event.target === event.currentTarget && !persistent) {\n      handleClose();\n    }\n  }\n  \n  function handleClose() {\n    dispatch('close');\n    onClose?.();\n  }\n  \n  function trapFocus(event: KeyboardEvent) {\n    if (event.key !== 'Tab') return;\n    \n    const focusableElements = modalElement.querySelectorAll(\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n    ) as NodeListOf<HTMLElement>;\n    \n    const firstElement = focusableElements[0];\n    const lastElement = focusableElements[focusableElements.length - 1];\n    \n    if (event.shiftKey && document.activeElement === firstElement) {\n      event.preventDefault();\n      lastElement?.focus();\n    } else if (!event.shiftKey && document.activeElement === lastElement) {\n      event.preventDefault();\n      firstElement?.focus();\n    }\n  }\n  \n  $: if (open) {\n    previouslyFocused = document.activeElement as HTMLElement;\n    document.body.style.overflow = 'hidden';\n    \n    // Focus management\n    setTimeout(() => {\n      const firstFocusable = modalElement?.querySelector(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n      ) as HTMLElement;\n      firstFocusable?.focus();\n    }, 100);\n  } else {\n    document.body.style.overflow = '';\n    previouslyFocused?.focus();\n  }\n  \n  onMount(() => {\n    return () => {\n      document.body.style.overflow = '';\n    };\n  });\n  \n  $: sizeClasses = {\n    sm: 'max-w-md',\n    md: 'max-w-lg',\n    lg: 'max-w-2xl',\n    xl: 'max-w-4xl',\n    full: 'max-w-none mx-4'\n  }[size];\n</script>\n\n<svelte:window onkeydown={open ? handleEscape : undefined} />\n\n{#if open}\n  <div\n    class=\"modal-backdrop\"\n    onclick={handleBackdropClick}\n    onkeydown={trapFocus}\n    transition:fly={{ y: -50, duration: 300, easing: quintOut }}\n  >\n    <div\n      bind:this={modalElement}\n      class=\"modal-content {sizeClasses}\"\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-labelledby={title ? 'modal-title' : undefined}\n      aria-describedby={description ? 'modal-description' : undefined}\n      transition:scale={{ start: 0.9, duration: 300, easing: quintOut }}\n    >\n      <!-- Header -->\n      {#if title || showCloseButton}\n        <header class=\"modal-header\">\n          <div class=\"modal-title-section\">\n            {#if title}\n              <h2 id=\"modal-title\" class=\"modal-title\">{title}</h2>\n            {/if}\n            {#if description}\n              <p id=\"modal-description\" class=\"modal-description\">{description}</p>\n            {/if}\n          </div>\n          \n          {#if showCloseButton}\n            <button\n              class=\"modal-close\"\n              onclick={handleClose}\n              aria-label=\"Close modal\"\n            >\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\">\n                <path d=\"M15 5L5 15M5 5L15 15\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>\n              </svg>\n            </button>\n          {/if}\n        </header>\n      {/if}\n      \n      <!-- Body -->\n      <div class=\"modal-body\">\n        {@render children?.()}\n      </div>\n      \n      <!-- Footer -->\n      {#if footer}\n        <footer class=\"modal-footer\">\n          {@render footer?.()}\n        </footer>\n      {/if}\n    </div>\n  </div>\n{/if}\n\n<style>\n  .modal-backdrop {\n    @apply fixed inset-0 z-50 flex items-center justify-center p-4;\n    background: rgba(0, 0, 0, 0.6);\n    backdrop-filter: blur(8px);\n    -webkit-backdrop-filter: blur(8px);\n  }\n  \n  .modal-content {\n    @apply relative w-full max-h-full overflow-hidden;\n    background: var(--surface-a);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-xl);\n    max-height: 90vh;\n    display: flex;\n    flex-direction: column;\n  }\n  \n  html.dark .modal-content {\n    background: var(--surface-elevated);\n    border-color: var(--border-hover);\n    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8);\n  }\n  \n  .modal-header {\n    @apply flex items-start justify-between p-6 pb-4;\n    border-bottom: 1px solid var(--border-color);\n  }\n  \n  .modal-title-section {\n    @apply flex-1 mr-4;\n  }\n  \n  .modal-title {\n    @apply text-xl font-semibold mb-1;\n    color: var(--text-1);\n  }\n  \n  .modal-description {\n    @apply text-sm;\n    color: var(--text-2);\n  }\n  \n  .modal-close {\n    @apply p-2 rounded-lg transition-all duration-200 hover:bg-black/5 dark:hover:bg-white/5;\n    color: var(--text-3);\n    background: transparent;\n    border: none;\n    cursor: pointer;\n  }\n  \n  .modal-close:hover {\n    color: var(--text-1);\n    transform: scale(1.1);\n  }\n  \n  .modal-body {\n    @apply flex-1 p-6 overflow-y-auto;\n    color: var(--text-1);\n  }\n  \n  .modal-footer {\n    @apply flex items-center justify-end gap-3 p-6 pt-4;\n    border-top: 1px solid var(--border-color);\n  }\n  \n  /* Size variants */\n  .max-w-none {\n    width: calc(100vw - 2rem);\n    height: calc(100vh - 2rem);\n  }\n  \n  /* Animation enhancements */\n  .modal-content {\n    animation: modalSlideIn 0.3s ease-out;\n  }\n  \n  @keyframes modalSlideIn {\n    from {\n      opacity: 0;\n      transform: translateY(-20px) scale(0.95);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0) scale(1);\n    }\n  }\n  \n  /* Focus styles */\n  .modal-content:focus {\n    outline: none;\n  }\n  \n  .modal-close:focus-visible {\n    outline: 2px solid var(--accent);\n    outline-offset: 2px;\n  }\n</style>
